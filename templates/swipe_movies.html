<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Swipes</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Center movie display */
        .movie-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-top: 20px;
        }

        /* Movie poster */
        .movie-poster {
            max-width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        /* Swipe buttons */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .swipe-buttons button {
            width: 80px;
            height: 80px;
            font-size: 20px;
            border-radius: 50%;
        }

        /* Genre tags */
        .genre-tags {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .genre-tag {
            background-color: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mt-5">Movie Swipes</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- ✅ Display User's Selected Genres -->
    {% if genres %}
    <div class="genre-tags">
        <strong>Selected Genres: </strong>
        {% for genre in genres %}
            <span class="genre-tag">{{ genre }}</span>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted text-center">Showing movies from all genres.</p>
    {% endif %}

    <!-- ✅ Movie Display Section -->
    {% if movie %}
    <div class="movie-container mt-4">
        <h3 class="movie-title">{{ movie.title }}</h3>
        <h5 class="text-muted">{{ movie.genre }}</h5>

        {% if movie.poster_url %}
            <img src="{{ movie.poster_url }}" class="movie-poster" alt="{{ movie.title }}">
        {% else %}
            <p class="text-muted">No image available</p>
        {% endif %}

        <div class="swipe-buttons">
            <button class="btn btn-danger" onclick="swipeMovie('dislike')">❌</button>
            <button class="btn btn-success" onclick="swipeMovie('like')">✅</button>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mt-4 text-center">No more movies available to swipe.</div>
    {% endif %}

    <!-- ✅ Matches Button with Auto-Updated Counter -->
    <div class="text-center mt-3">
        <a href="{{ url_for('view_matches') }}" class="btn btn-primary position-relative">
            Matches <span id="match-count" class="badge badge-light">{{ matches_count }}</span>
        </a>
    </div>

    <!-- ✅ Back to Profile Button -->
    <div class="mt-3 text-center">
        <form action="{{ url_for('profile') }}">
            <button type="submit" class="btn btn-secondary">Back to Profile</button>
        </form>
    </div>    
</div>

<!-- ✅ JavaScript for Handling Swipes & Auto-Updating Match Count -->
<script>
    function swipeMovie(action) {
        fetch("{{ url_for('swipe_movies') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                movie_id: "{{ movie.id if movie else '' }}", 
                action: action 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // ✅ Refresh to get a new movie
            } else {
                alert("❌ Error processing your swipe.");
            }
        })
        .catch(error => console.error("Error:", error));
    }

    function updateMatchCount() {
        fetch("{{ url_for('swipe_movies') }}", {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("match-count").innerText = data.matches_count;
        })
        .catch(error => console.error("Error updating match count:", error));
    }

    // ✅ Auto-update match count every 5 seconds
    setInterval(updateMatchCount, 5000);
</script>


</body>
</html>
